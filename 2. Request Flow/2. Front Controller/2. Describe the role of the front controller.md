#  Describe the role of the front controller

# Overview

The front controller does the following:

1. Gather all routes (init) method
2. Dispatches event and apply Database url rewrites (catalag, category)
3. Match exact router
4. Send output generated by controller

App - run $this->getFrontController()->dispatch();


# 1. Gather routes

The init method is called from:

    $this->getFrontController()->dispatch();


## 1.1 Mage_Core_Controller_Varien_Front()->init();

1. Mage_Core_Model_App->getFrontController() calls \_initFrontController()
2. Creates a class object of Mage_Core_Controller_Varien_Front() and calls init method.


This init method will get router classes from config <web><routers> node e.g.


- Mage_Core_Controller_Varien_Router_Admin
- Mage_Core_Controller_Varien_Router_Standard


## 1.2 Router classes registered

Firstly these routers are registered in config.xml of Mage core

    <web>
        <routers>
            <admin>
                <area>admin</area>
                <class>Mage_Core_Controller_Varien_Router_Admin</class>
            </admin>
            <standard>
                <area>frontend</area>
                <class>Mage_Core_Controller_Varien_Router_Standard</class>
            </standard>
        </routers>


## 1.3 How routers are added in config.xml


Just to go over how routers are registered in the config.xml files of modules

1. Frontend


    <frontend>
      <routers>
          <catalog>
              <use>standard</use>
              <args>
                  <module>Mage_Catalog</module>
                  <frontName>catalog</frontName>
              </args>
          </catalog>
      </routers>


*app/code/core/Mage/Catalog/controllers/IndexController.php*

    class Mage_Catalog_IndexController extends Mage_Core_Controller_Front_Action
    {
      ..
    }

2. Admin


    <admin>
      <routers>
          <adminhtml>
              <use>admin</use>
              <args>
                  <module>Mage_Adminhtml</module>
                  <frontName>admin</frontName>
              </args>
          </adminhtml>
      </routers>

*app/code/core/Mage/Adminhtml/controllers/IndexController.php*

      class Mage_Adminhtml_IndexController extends Mage_Adminhtml_Controller_Action
      {
          ...
      }

Back to the code it loops through the routers and does the following:

- Creates class
- Collect routes for that area
- Adds route


## 1.4 Mage_Core_Controller_Front_Action->collectRoutes()

This router does the following:

1. Gets all the nodes for config -> frontend -> routers that <use>standard</use>.
It then creates an empty array called $modules

2. If an node <before> exists, it will add that module to its arguments
3. Similarly if there is a node <after>
4. It then adds the module to the addModule method


    $frontName = (string)$routerConfig->args->frontName;
    $this->addModule($frontName, $modules, $routerName);

e.g.

  $this->addModule('catalog', array('Mage_Catalog'), 'catalog');

## 1.5 Add Routers

Back in the init method it adds the router to class to the method addRouter()

    $this->addRouter($routerCode, $router);

e.g.

    $this->addRouter('front', $router);


# 1.6. CMS and Default Router

These are added as following. After looping through the 2 routers the following event is dispacthed:


    Mage::dispatchEvent('controller_front_init_before', array('front'=>$this));

So if we look in *app/code/core/Mage/Cms/etc/config.xml*


      <events>
          <controller_front_init_routers>
              <observers>
                  <cms>
                      <class>Mage_Cms_Controller_Router</class>
                      <method>initControllerRouters</method>
                  </cms>
              </observers>
          </controller_front_init_routers>
      </events>

This registers the CMS router :

    public function initControllerRouters($observer)
    {
        $front = $observer->getEvent()->getFront();
        $front->addRouter('cms', $this);
    }


**Note:** Important for the exam.


    $default = new Mage_Core_Controller_Varien_Router_Default();
    $this->addRouter('default', $default);


So at the end you have 4 routers:

1. admin - Mage_Core_Controller_Varien_Router_Admin
2. standard - Mage_Core_Controller_Varien_Router_Standard
3. cms - Mage_Cms_Controller_Router
4. default - Mage_Core_Controller_Varien_Router_Default


# 2. Dispatch Event + apply Database URL rewrites

Mage_Core_Controller_Varien_Front->dispatch()

1. Gets Request Object - Mage_Core_Controller_Request_Http
2. Checks Magento is installed or not posting data and that the base URL is correct in \_checkBaseUrl() method
3. Sets dispatch to false
4. Apply rewrites and if exists redirects user
5. Loops through rewrites until one matches


## 2.1 Apply Rewrites Mage_Core_Model_Url_Rewrite_Request->rewrite();

This checks if a path exists in the core_url_rewrite table from the method \_rewriteDb()

So for example sample-product.html would also be catalog/product/view/id/1. This would be saved in the core_url_rewrite table and Magento would now know that this the request.

Please note more information in next section on how URL rewrites work.

**Note:** it also checks if there are global -> rewrite nodes and redirects them but this is not used anymore.


# 3. Match exact router

So all the controller routers (4 by default) extend from the abstract class *Mage_Core_Controller_Varien_Router_Abstract* which has an abstract method called match

    abstract public function match(Zend_Controller_Request_Http $request)

So in the method dispatch() we loop through all controllers and check for a match for the URL.


In the method match the router would call the controller and method for the router

So for example sample-product.html would use the Mage_Core_Controller_Varien_Router_Standard and then call Mage_Catalog_ProductController->viewAction() as its really catalog/product/view/id/{{id}}


**Note:** The default router handles the 404 so this is why its added last.

We should also not the priority of routers - admin, standard, cms, default


# 4. Dispatch Event

Finally the front controller is dispatched and returns the response.


    $this->getResponse()->sendResponse();



# 5. Important Dispatch Events for the Exam

Below is a list of important dispatch events which we need to know how to use for the exam:

Info to follow shortly.
